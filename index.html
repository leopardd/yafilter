<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Image filter</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="input" id="input">

</div>

<div class="outputs clearfix">
  <div id="original" class="box">
    <img src="">
    <div class="desc">
      <div class="title">Original</div>
      <div class="status"></div>
    </div>
  </div>

  <div id="grayscale" class="box">
    <img src="">
    <div class="desc">
      <div class="title">Grayscale</div>
      <div class="status"></div>
    </div>
  </div>

  <div id="rotate" class="box">
    <img src="">
    <div class="desc">
      <div class="title">Rotate</div>
      <div class="status"></div>
    </div>
  </div>

  <div id="flip" class="box">
    <img src="">
    <div class="desc">
      <div class="title">Flip</div>
      <div class="status"></div>
    </div>
  </div>

  <div id="blur" class="box">
    <img src="">
    <div class="desc">
      <div class="title">Blur</div>
      <div class="status"></div>
    </div>
  </div>

  <div id="gaussian-blur" class="box">
    <img src="">
    <div class="desc">
      <div class="title">Gaussian blur</div>
      <div class="status"></div>
    </div>
  </div>

  <div id="sharpen" class="box">
    <img src="">
    <div class="desc">
      <div class="title">Sharpen</div>
      <div class="status"></div>
    </div>
  </div>  

  <div id="invert" class="box">
    <img src="">
    <div class="desc">
      <div class="title">Invert</div>
      <div class="status"></div>
    </div>
  </div>
</div>
<script>
var Box = function(selectorId) {
  this.id = selectorId;
  this.ele = document.getElementById(this.id);
  this.imgEle = document.querySelectorAll('#' + this.id + ' > img')[0];
  this.statusEle = document.querySelectorAll('#' + this.id + ' .status')[0];

  this.updateStatus = function(text) {
    this.statusEle.innerHTML = text;
  };

  this.updateImage = function(dataUrl) {
    this.imgEle.src = dataUrl;
  };

  this.addClass = function(className) {
    this.ele.className += ' ' + className;
  };
};

var image,
  originalBox = new Box('original'),
  canvas,
  ctx;

function getDataUri(url, callback) {
  image = new Image();

  image.onload = function() {
    var imageData,
      dataUri;

    canvas = document.createElement('canvas');
    ctx = canvas.getContext('2d');
    
    canvas.width = this.width;
    canvas.height = this.height;

    ctx.drawImage(this, 0, 0);

    imageData = ctx.getImageData(0, 0, this.width, this.height);

    callback(imageData);
  };

  image.src = url;
  image.style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
  console.log('Ready');

  getDataUri('image/people.png', function(imageData) {

    // imageData.data
    // 
    // [
    //   r1, g1, b1, a1 (255),
    //   r2, g2, b2, a2,
    //   ...
    // ]
    
    ctx.putImageData(imageData, 0, 0);
    originalBox.updateImage(canvas.toDataURL('image/png'));
    originalBox.updateStatus('Complete');
    originalBox.addClass('done');

    var imgProWorkerTasks = [
      {
        boxId: 'grayscale',
        func: 'toGrayscale'
      },
      {
        boxId: 'rotate',
        func: 'toRotate'
      },
      {
        boxId: 'flip',
        func: 'toFlip'
      },
      {
        boxId: 'blur',
        func: 'toBlur'
      },
      {
        boxId: 'gaussian-blur',
        func: 'toGaussianBlur'
      },
      {
        boxId: 'sharpen',
        func: 'toSharpen'
      },
      {
        boxId: 'invert',
        func: 'toInvert'
      }
    ];

    imgProWorkerTasks.forEach(function(task) {
      var worker = new Worker('js/script.js'),
        box = new Box(task.boxId);

      box.updateStatus('Processing');

      worker.onmessage = function(e) {
        var imageData = JSON.parse(e.data.imageData),
          func = e.data.func;

        imageData = new ImageData(
          (new Uint8ClampedArray(imageData.data)),
          imageData.width,
          imageData.height
        );

        ctx.putImageData(imageData, 0, 0);
        box.updateImage(canvas.toDataURL('image/png'));
        box.updateStatus('Complete');
        box.addClass('done');
      };

      // prepare data for sending
      var arrayedImageData = {};
      // need to be array
      arrayedImageData['data'] = Array.from(imageData.data);
      arrayedImageData['width'] = imageData.width;
      arrayedImageData['height'] = imageData.height;

      var msg = {
        'imageData' : JSON.stringify(arrayedImageData),
        'boxId'     : task.boxId,
        'func'      : task.func
      };
      worker.postMessage(msg);
    });
  });
});
</script>
</body>
</html>
