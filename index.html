<!DOCTYPE html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>YA filter</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="input" id="input">

</div>
<div class="outputs clearfix" id="outputs">

</div>
<script id="box-template" type="text/x-handlebars-template">
  <div id="{{boxId}}" class="box">
    <img src="">
    <div class="desc">
      <div class="title">{{title}}</div>
      <div class="status"></div>
    </div>
  </div>
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.min.js"></script>
<script src="js/script.js"></script>
<script>
var Box = function(selectorId) {
  this.id = selectorId;
  this.ele = document.getElementById(this.id);
  this.imgEle = document.querySelectorAll('#' + this.id + ' > img')[0];
  this.statusEle = document.querySelectorAll('#' + this.id + ' .status')[0];

  this.updateStatus = function(text) {
    this.statusEle.innerHTML = text;
  };

  this.updateImage = function(dataUrl) {
    this.imgEle.src = dataUrl;
  };

  this.addClass = function(className) {
    this.ele.className += ' ' + className;
  };
};

var imageName,
  imageName2,
  imageData,
  imageData2,
  pixelPanels,
  pixelPanels2,
  outputs = document.getElementById('outputs'),
  canvas = document.createElement('canvas'),
  ctx = canvas.getContext('2d');

/**
 * Get ImageData
 * 
 * @see https://davidwalsh.name/convert-image-data-uri-javascript
 * @see http://stackoverflow.com/questions/934012/get-image-data-in-javascript
 *
 * @param {string}   url
 * @param {Function} callback callback function
 */
function getImageData(url, callback) {
  var image = new Image();

  image.onload = function() {
    var imageData,
      canvas = document.createElement('canvas'),
      ctx = canvas.getContext('2d');
    
    canvas.width = this.width;
    canvas.height = this.height;

    ctx.drawImage(this, 0, 0);

    // imageData.data
    // 
    // [
    //   r1, g1, b1, a1 (255),
    //   r2, g2, b2, a2,
    //   ...
    // ]
    imageData = ctx.getImageData(0, 0, this.width, this.height);

    callback(imageData);
  };

  image.src = url;
  image.style.display = 'none';
}

function getPixelPanels(url, callback) {
  getImageData(url, function(imageData) {
    var pixelPanels = Convert.imageDataToPixelPanels(imageData);

    callback(pixelPanels);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  console.log('Ready');

  imageName = 'image/running-shoes.png';
  imageName2 = 'image/baby.png';

  // TODO: fix callback (using Promise instead)
  getPixelPanels(imageName, function(data) {
    pixelPanels = data;

    getPixelPanels(imageName2, function(data) {
      pixelPanels2 = data;

      startApp();
    });
  })

  function startApp() {
    var imgProWorkerTasks = [
      {
        boxId: 'original',
        title: 'Original',
        func: 'original' 
      },
      {
        boxId: 'grayscale',
        title: 'Grayscale',
        func: 'grayscale'
      },
      {
        boxId: 'rotate',
        title: 'Rotate',
        func: 'rotate'
      },
      {
        boxId: 'flip',
        title: 'Flip',
        func: 'flip'
      },
      {
        boxId: 'blur',
        title: 'Blur',
        func: 'blur'
      },
      {
        boxId: 'combine',
        title: 'Combine',
        func: 'combine',
        arg2: JSON.stringify(pixelPanels2),
      },
      {
        boxId: 'over',
        title: 'Over',
        func: 'over',
        arg2: JSON.stringify(pixelPanels2),
      },
      {
        boxId: 'fill-ffb9f1',
        title: 'Fill #ffb9f1',
        func: 'fill',
        arg2: JSON.stringify('#ffb9f1')
      },
      {
        boxId: 'resize-200-100',
        title: 'Resize w200 h100',
        func: 'resize',
        arg2: 200,
        arg3: 100
      },
      {
        boxId: 'crop-out-of-index',
        title: 'Crop - Out of index',
        func: 'crop',
        arg2: 100,
        arg3: 100,
        arg4: 500,
        arg5: 500
      },
      {
        boxId: 'crop-100-100-50-100',
        title: 'Crop 100 100 50 100',
        func: 'crop',
        arg2: 100,
        arg3: 100,
        arg4: 200,
        arg5: 80
      },
      {
        boxId: 'resize-canvas-unsupport-scale-down',
        title: 'Resize canvas - Unsupport scale down',
        func: 'resizeCanvas',
        arg2: 100,
        arg3: 100
      },
      {
        boxId: 'resize-canvas',
        title: 'Resize canvas',
        func: 'resizeCanvas',
        arg2: 500,
        arg3: 400
      },
      {
        boxId: 'gaussian-blur',
        title: 'Gaussian blur',
        func: 'gaussianBlur'
      },
      {
        boxId: 'sharpen',
        title: 'Sharpen',
        func: 'sharpen'
      },
      {
        boxId: 'invert',
        title: 'Invert',
        func: 'invert'
      },
      {
        boxId: 'threshold-63',
        title: 'Threshold 63',
        func: 'threshold',
        arg2: 63
      },
      {
        boxId: 'threshold-127',
        title: 'Threshold 127',
        func: 'threshold',
        arg2: 127
      },
      {
        boxId: 'threshold-191',
        title: 'Threshold 191',
        func: 'threshold',
        arg2: 191
      },
      {
        boxId: 'brightness-80',
        title: 'Brightness 80',
        func: 'brightness',
        arg2: 80
      },
      {
        boxId: 'darkness-80',
        title: 'Darkness 80',
        func: 'darkness',
        arg2: 80
      },
    ];

    // compile template
    var boxTemplateSource = document.getElementById('box-template').innerHTML;
    var boxTemplate = Handlebars.compile(boxTemplateSource);
    var html = '';
    imgProWorkerTasks.forEach(function(task) {
      html += boxTemplate(task);
    });
    outputs.innerHTML = html;

    imgProWorkerTasks.forEach(function(task) {
      var worker = new Worker('js/script.js'),
        box = new Box(task.boxId),
        msg = {
          'pixelPanels' : JSON.stringify(pixelPanels),
          'func'        : task.func,
          'arg2'        : task.arg2 || null,
          'arg3'        : task.arg3 || null,
          'arg4'        : task.arg4 || null,
          'arg5'        : task.arg5 || null,
        };

      box.updateStatus('Processing');
      worker.postMessage(msg);
      worker.onmessage = function(e) {
        var pixelPanels = JSON.parse(e.data.pixelPanels),
          imageData = Convert.pixelPanelsToImageData(pixelPanels);

        canvas.width = imageData.width;
        canvas.height = imageData.height;

        ctx.putImageData(imageData, 0, 0);
        box.updateImage(canvas.toDataURL('image/png'));
        box.updateStatus('Complete');
        box.addClass('done');
      };
    });
  }
});
</script>
</body>
</html>
